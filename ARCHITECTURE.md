# ProjectFlow 系統架構文件

## 系統概述

ProjectFlow 是一個基於多智能體（Multi-Agent）架構的專案學習輔助系統，專為 Problem-Based Learning (PrBL) 和 Project-Based Learning (PBL) 設計。系統透過四個協作智能體，引導學生完成從問題探索到行動規劃的完整學習歷程。

## 核心設計理念

### 教育理論基礎
- **問題導向學習 (PrBL)**：從真實問題出發，引導學生主動探究
- **專案導向學習 (PBL)**：透過實作專案，培養學生綜合能力
- **SDGs 永續發展目標**：聚焦聯合國永續發展目標，培養社會責任感

### 系統設計原則
1. **分層處理**：將學習過程分為問題探索、進度評估、策略決策、回應生成四個層次
2. **非同步更新**：背景智能體獨立運行，不阻塞主對話流程
3. **狀態持久化**：完整保存對話歷史與學習進度
4. **漸進引導**：根據學生程度提供適當的鷹架支援

## 系統架構圖

```
┌─────────────────────────────────────────────────────────────┐
│                        使用者介面層                           │
│  ┌──────────────────┐          ┌──────────────────┐         │
│  │  Web Interface   │          │   API Server     │         │
│  │ (Gradio 7860)    │          │   (FastAPI 8000) │         │
│  └────────┬─────────┘          └────────┬─────────┘         │
└───────────┼──────────────────────────────┼──────────────────┘
            │                              │
            └──────────────┬───────────────┘
                           │
┌──────────────────────────┼───────────────────────────────────┐
│                    核心處理層                                  │
│              ┌────────────▼────────────┐                      │
│              │   projectflow_graph     │                      │
│              │   (LangGraph Workflow)  │                      │
│              └─────────┬───────────────┘                      │
│                        │                                      │
│    ┌───────────────────┴──────────────────┐                  │
│    │                                       │                  │
│    ▼                                       ▼                  │
│ ┌─────────────────┐              ┌─────────────────┐         │
│ │  Main Workflow  │              │Background Workflow│        │
│ │                 │              │                 │         │
│ │ ┌─────────────┐ │              │ ┌─────────────┐ │         │
│ │ │Decision Agent│ │              │ │Summary Agent│ │         │
│ │ └──────┬──────┘ │              │ └──────┬──────┘ │         │
│ │        │        │              │        │        │         │
│ │        ▼        │              │        ▼        │         │
│ │ ┌─────────────┐ │              │ ┌─────────────┐ │         │
│ │ │Response Agent│ │              │ │ Score Agent │ │         │
│ │ └─────────────┘ │              │ └─────────────┘ │         │
│ └─────────────────┘              └─────────────────┘         │
└───────────────────────────────────────────────────────────────┘
                           │
┌──────────────────────────┼───────────────────────────────────┐
│                      資料層                                    │
│              ┌────────────▼────────────┐                      │
│              │   Session Management    │                      │
│              │  (Pickle Persistence)   │                      │
│              └─────────────────────────┘                      │
│                                                                │
│  session_data/                                                 │
│  ├── state_{session_id}.pkl    # 對話狀態                      │
│  └── 專案計畫書_{session_id}.md  # 專案文件                    │
└────────────────────────────────────────────────────────────────┘
```

## 智能體詳細說明

### 1. Summary Agent (摘要智能體)
**職責**：維護專案內容與學習歷程記錄

**輸入**：
- 當前對話內容
- 既有專案內容
- 行動計畫
- 歷史記錄

**處理邏輯**：
1. 從對話中提取新的專案資訊
2. 更新專案內容（project_content）
3. 維護行動計畫（action_plan）
4. 記錄歷史進程（historical_log）
5. 判斷並更新學習階段（stage_number）

**輸出**：
```json
{
  "project_content": "更新後的專案內容",
  "ACTION_PLAN": "更新後的行動計畫",
  "HISTORICAL_LOG": "更新後的歷史記錄",
  "stage_number": 1
}
```

**關鍵規則**：
- 僅基於學生明確表達的內容更新
- 不主觀推測或自動補全
- 階段切換須有明確依據

### 2. Score Agent (評分智能體)
**職責**：評估學生在當前階段的學習表現

**輸入**：
- 當前對話
- 專案內容
- 行動計畫
- 當前進度與評分

**處理邏輯**：
1. 分析學生回應是否符合階段目標
2. 根據評分項目給予 1-5 分
3. 累積評分（不降分原則）
4. 更新評分說明

**輸出**：
```json
{
  "current_progress": "更新後的進度與評分"
}
```

**評分原則**：
- 歷史累積：分數反映整體表現
- 正向激勵：只上調不降分
- 具體回饋：提供評分理由

### 3. Decision Agent (決策智能體)
**職責**：決定下一步引導策略

**輸入**：
- 當前對話
- 專案內容
- 行動計畫
- 歷史記錄
- 當前進度與評分

**處理邏輯**：
1. 分析評分狀況
2. 識別需加強項目
3. 選擇適當引導策略
4. 判斷是否進入總結階段

**輸出**：
```json
{
  "Guidance_and_Strategy": "引導策略說明"
}
```

**引導策略**：
- 提問、鼓勵、案例引導、微引導
- 總結、回應問題等
- 根據階段限制調整策略

### 4. Response Agent (回應智能體)
**職責**：生成友善且有效的對話回應

**輸入**：
- 所有歷史對話
- 引導策略
- 專案內容
- 行動計畫

**處理邏輯**：
1. 同理回應學生
2. 根據策略引導
3. 提供適當鷹架
4. 維持對話連貫性

**輸出**：直接返回對話文字

**回應風格**：
- 清晰易懂
- 適度鼓勵
- 加入 Emoji
- 避免重複提問

## 工作流程

### 主工作流程 (Main Workflow)
```
用戶輸入 → Decision Agent → Response Agent → 回應用戶
                  ↓
          (觸發背景工作流程)
```

### 背景工作流程 (Background Workflow)
```
Summary Agent → Score Agent → 更新狀態 → 持久化儲存
```

**特點**：
- 異步執行，不阻塞主流程
- 獨立執行緒處理
- 結果透過檔案系統共享

## 資料模型

### AgentState (核心狀態)
```python
{
    "messages": List[HumanMessage | AIMessage],
    "project_content": str,           # 專案內容
    "action_plan": str,                # 行動計畫
    "historical_log": str,             # 歷史記錄
    "current_progress": str,           # 當前進度與評分
    "guidance_strategy": str,          # 引導策略
    "score": str,                      # 評分
    "next_response": Optional[dict],   # 下一個回應
    "session_id": str,                 # 會話 ID
    "next_agent": Optional[str],       # 下一個智能體
    "stage_number": Optional[int]      # 學習階段編號
}
```

### 學習階段定義
**階段一：PBL 問題探索**
- 目標：建立問題意識與 SDGs 連結
- 評分項目：
  - 個人與情境關聯
  - 現象描述與因果脈絡
  - SDGs 連結

**階段二：PBL 探索行動決定**
- 目標：規劃具體可行的探索行動
- 評分項目：
  - 提出可執行的具體行動
  - 說明行動的影響與合理性
  - 了解可運用的資源

## 技術棧

### 核心框架
- **LangGraph**：工作流程編排
- **LangChain**：LLM 整合
- **FastAPI**：API 服務
- **Gradio**：Web 介面

### LLM 支援
- **OpenAI**：支援 OpenAI API 相容端點
- **Google Vertex AI**：支援 Gemini 模型

### 資料持久化
- **Pickle**：狀態序列化
- **YAML**：配置管理
- **Markdown**：文檔輸出

### 開發工具
- **uv**：Python 套件管理
- **tiktoken**：Token 計數
- **python-dotenv**：環境變數管理

## 設計模式

### 1. State Machine Pattern
使用 LangGraph 的狀態機模式管理對話流程

### 2. Strategy Pattern
Decision Agent 根據評分動態選擇引導策略

### 3. Observer Pattern
背景工作流程監聽主流程，獨立更新狀態

### 4. Repository Pattern
統一的狀態持久化介面（background_tool）

## 擴展性設計

### 新增學習階段
1. 在 `prompts/stage_setting.yaml` 定義新階段
2. 配置階段名稱、主要議題、評分項目
3. 系統自動識別並套用

### 新增智能體
1. 定義 agent 函式
2. 加入對應的 prompt 模板
3. 在 workflow builder 中註冊

### 自訂 LLM
1. 設定環境變數
2. 選擇對應的 LangChain wrapper
3. 調整 temperature、timeout 等參數

## 安全性考量

### 資料隔離
- 每個 session 獨立儲存
- UUID 作為 session_id 防止衝突

### API 安全
- API server 預留 API key 驗證機制
- 建議部署時啟用驗證

### 敏感資料
- 環境變數管理 API keys
- .gitignore 排除 .env 檔案

## 效能優化

### Token 管理
- 計數所有輸入輸出 token
- 分 agent 統計使用量
- 支援成本追蹤

### 對話歷史
- 限制傳遞給 LLM 的歷史長度
- Response Agent 取最近 10 則
- Summary/Score/Decision Agent 取最近 3 則

### 異步處理
- 背景工作流程不阻塞回應
- 獨立執行緒處理狀態更新

## 已知限制

1. **狀態同步**：背景更新需透過檔案系統，存在延遲
2. **並發處理**：單一 session 未處理並發請求
3. **錯誤恢復**：LLM 失敗時的 fallback 機制有限
4. **多語言支援**：目前僅支援繁體中文

## 未來改進方向

1. **資料庫整合**：從 Pickle 遷移到 PostgreSQL
2. **即時狀態同步**：使用 Redis 或 WebSocket
3. **多語言支援**：i18n 國際化
4. **增強分析**：學習成效儀表板
5. **更多引導策略**：整合更多教學法
